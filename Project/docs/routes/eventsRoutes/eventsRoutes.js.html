<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: eventsRoutes.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: eventsRoutes.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
import { string, date as date2String, sendResponse, sendError, execute } from "../scripts/db.js";

const commandGetAll = `
    SELECT e.id, e.description, e.date, et.description AS type_description
    FROM events e
    JOIN event_types et ON e.type_id = et.id
`;
const commandCreate = "INSERT INTO events (description, type_id, date) VALUES (?, ?, ?)";
const commandUpdate = "UPDATE events SET description = ?, type_id = ?, date = ? WHERE id = ?";
const commandDelete = "DELETE FROM events WHERE id = ?";

const checkMemberDependency = async (eventId) => {
    const command = "SELECT COUNT(*) AS member_count FROM member_enrolled_events WHERE event_id = ?";
    const result = await execute(command, [eventId]);
    return result?.[0]?.member_count > 0;
};

/**
 * Configura as rotas para operações relacionadas com eventos.
 * @param {Object} app - A instância da aplicação Express.
 */
export default async function eventsRoutes(app) {
    /**
     * Obtém todos os eventos.
     * @param {Object} request - O objeto do pedido HTTP.
     * @param {Object} response - O objeto da resposta HTTP.
     */
    app.get("/events", async (request, response) => {
        await sendResponse(response, commandGetAll);
    });

    /**
     * Cria um novo evento.
     * @param {Object} request - O objeto do pedido HTTP.
     * @param {Object} response - O objeto da resposta HTTP.
     */
    app.post("/events", async (request, response) => {
        const description = string(request.body.description);
        const type_id = Number(request.body.type_id);
        const date = date2String(request.body.date);
        if (description &amp;&amp; type_id &amp;&amp; date) {
            await sendResponse(response, commandCreate, [description, type_id, date], (result) => ({
                id: result.insertId,
                description,
                type_id,
                date,
            }));
        } else {
            sendError(response, "Deve fornecer uma descrição, um ID de tipo e uma data para o evento!");
        }
    });

    /**
     * Atualiza um evento existente.
     * @param {Object} request - O objeto do pedido HTTP.
     * @param {Object} response - O objeto da resposta HTTP.
     */
    app.put("/events/:id", async (request, response) => {
        const id = Number(request.params.id);
        const description = string(request.body.description);
        const type_id = Number(request.body.type_id);
        const date = date2String(request.body.date);
        if (id &amp;&amp; description &amp;&amp; type_id &amp;&amp; date) {
            await sendResponse(response, commandUpdate, [description, type_id, date, id], () => ({
                id,
                description,
                type_id,
                date,
            }));
        } else {
            sendError(response, "Deve fornecer um ID válido, uma descrição, um ID de tipo e uma data!");
        }
    });

    /**
     * Elimina um evento verificando se está associado a menbros.
     * @param {Object} request - O objeto do pedido HTTP.
     * @param {Object} response - O objeto da resposta HTTP.
     */
    app.delete("/events/:id", async (request, response) => {
        const id = Number(request.params.id);
        if (!id) {
            return sendError(response, "Deve fornecer um ID válido!");
        }

        try {
            const isUsedByMember = await checkMemberDependency(id);
            if (isUsedByMember) {
                return sendError(
                    response,
                    "Não é possível eliminar o evento: Está associado a um ou mais membros."
                );
            }

            await sendResponse(response, commandDelete, [id], () => ({
                id,
            }));
        } catch (error) {
            console.error("Erro ao eliminar evento:", error);
            sendError(response, "Ocorreu um erro ao eliminar o evento.");
        }
    });
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Feb 21 2025 22:13:36 GMT+0000 (Hora padrão da Europa Ocidental)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
